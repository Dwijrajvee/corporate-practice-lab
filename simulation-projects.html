<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projects Simulation - CPL</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f5f7fa; margin: 0; height: 100vh; display: flex; flex-direction: column; }
    
    .top-bar { background: #1e3a8a; /* Dark Blue for Projects */ color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .timer { font-weight: bold; color: #fbbf24; font-family: monospace; font-size: 1.2rem; }

    .container { display: flex; flex: 1; overflow: hidden; }
    
    /* LEFT: FACTS SHEET */
    .doc-panel { flex: 1; background: white; padding: 40px; overflow-y: auto; border-right: 1px solid #ddd; }
    .fact-sheet { background: #eff6ff; padding: 20px; border-radius: 8px; border: 1px solid #bfdbfe; margin-bottom: 20px; }
    .fact-title { color: #1e40af; font-weight: bold; margin-bottom: 5px; display: block; }

    /* RIGHT: DRAFTING */
    .task-panel { flex: 1; background: #f9fafb; padding: 30px; overflow-y: auto; }
    .task-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
    label { display: block; font-weight: bold; margin-bottom: 8px; color: #374151; }
    textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; line-height: 1.4; }
    
    .btn-submit { background: #059669; color: white; width: 100%; padding: 15px; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

  <div class="top-bar">
    <div>⚡ <strong>Projects: Change in Law Notice</strong></div>
    <div class="timer">Time Left: 45:00</div>
  </div>

  <div class="container">
    <div class="doc-panel">
      <h2>Case Brief</h2>
      
      <div class="fact-sheet">
        <span class="fact-title">Client:</span>
        SolarPower India Pvt Ltd (Generator)
      </div>

      <div class="fact-sheet">
        <span class="fact-title">Counterparty:</span>
        Madhya Pradesh Power Management Co. (Discom)
      </div>

      <p><strong>The Facts:</strong></p>
      <ul>
        <li><strong>PPA Date:</strong> 15 Jan 2024</li>
        <li><strong>Event:</strong> On 01 Feb 2024, Ministry of Finance issued Notification No. 12/2024 increasing Basic Customs Duty (BCD) on Solar Modules from 0% to 20%.</li>
        <li><strong>Impact:</strong> Project cost increased by ₹50 Crores.</li>
      </ul>

      <hr>

      <h3>Relevant PPA Clause</h3>
      <div style="background:#f3f4f6; padding:15px; border-left:4px solid #666; font-style:italic;">
        <strong>Article 12: Change in Law</strong><br>
        "12.1. 'Change in Law' means the occurrence of any of the following events after the Effective Date resulting into any additional recurring/non-recurring expenditure...<br>
        (a) the enactment, coming into effect, adoption, promulgation, amendment, modification or repeal of any Law or regulation..."
      </div>
      
      <p style="color:red; font-size:0.9rem;"><strong>Warning:</strong> You must notify the Discom within 30 days of the event, otherwise the claim is waived.</p>
    </div>

    <div class="task-panel">
      
      <div class="task-card">
        <label>1. Legal Analysis</label>
        <p style="font-size:0.9em; color:#666;">Does the Notification constitute a "Change in Law" under Article 12? Explain why briefly.</p>
        <textarea id="analysis" placeholder="Yes, because..."></textarea>
      </div>

      <div class="task-card">
        <label>2. Draft the Notice (Body Paragraphs)</label>
        <p style="font-size:0.9em; color:#666;">Draft the operative part of the notice to the Discom claiming the ₹50 Cr compensation. Be formal and firm.</p>
        <textarea id="draft" placeholder="We write to inform you that..."></textarea>
      </div>

      <button class="btn-submit" onclick="submitSimulation()">SUBMIT NOTICE</button>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://zfvrszqwuziwmunayfrv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmdnJzenF3dXppd211bmF5ZnJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NTMzNTYsImV4cCI6MjA4MzUyOTM1Nn0.0EGxBLGH8nqXCUPyMV9cJQJLM6oWCBJXpDcIUCDVU6I";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function submitSimulation() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) { alert("Please login first."); return; }
      
      // Auto-create simulation entry for PPA if missing (Simplified for MVP)
      // Note: In real app, we'd fetch the specific ID for 'Projects' simulation
      // For now, we will save it generically to the responses table
      
      // 1. Get/Create Attempt
      const { data: attempt } = await supabaseClient.from('attempts').insert([
        { user_id: session.user.id, status: 'submitted', submitted_at: new Date() } 
        // Note: In a robust build, we would look up the specific simulation_id for 'Projects'
      ]).select().single();

      // 2. Save Response
      const analysis = document.getElementById("analysis").value;
      const draft = document.getElementById("draft").value;

      await supabaseClient.from('responses').insert([{
        attempt_id: attempt.id,
        risks: "PROJECTS TRACK: " + analysis, // Re-using columns for MVP
        clause_edits: draft,
        client_email: "N/A"
      }]);

      alert("✅ Notice Drafted & Submitted!");
      window.location.href = "/dashboard.html";
    }
  </script>

</body>
</html>
