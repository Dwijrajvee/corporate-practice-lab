<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NDA Simulation - CPL</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f5f7fa; margin: 0; height: 100vh; display: flex; flex-direction: column; }
    .top-bar { background: #111827; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    .container { display: flex; flex: 1; overflow: hidden; }
    .doc-panel { flex: 1; background: white; padding: 40px; overflow-y: auto; border-right: 1px solid #ddd; }
    .task-panel { flex: 1; background: #f9fafb; padding: 30px; overflow-y: auto; }
    .task-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
    textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
    .btn-submit { background: #059669; color: white; width: 100%; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .btn-submit:hover { background: #047857; }
  </style>
</head>
<body>

  <div class="top-bar">
    <div>üìù <strong>NDA Review Simulation</strong></div>
    <div>Time Left: 75:00</div>
  </div>

  <div class="container">
    <div class="doc-panel">
      <h2>Non-Disclosure Agreement</h2>
      <p><strong>This Agreement</strong> is made on [Date] between <strong>TechStart Inc.</strong> and <strong>Investor Co.</strong>.</p>
      <br>
      <p><strong>1. Confidential Information:</strong> Includes all data shared by Discloser.</p>
      <p><strong>2. Obligations:</strong> Recipient shall keep information confidential for 10 years.</p>
      <p><strong>3. No Compelled Disclosure:</strong> Recipient is prohibited from disclosing to courts.</p>
    </div>

    <div class="task-panel">
      <div class="task-card">
        <label>1. Risk Identification</label>
        <textarea id="risks" placeholder="Identify top 3 risks..."></textarea>
      </div>
      <div class="task-card">
        <label>2. Clause Edits</label>
        <textarea id="edits" placeholder="Rewrite the bad clause..."></textarea>
      </div>
      <div class="task-card">
        <label>3. Client Email</label>
        <textarea id="email" placeholder="Draft email to client..."></textarea>
      </div>
      <button class="btn-submit" onclick="submitSimulation()">SUBMIT ASSESSMENT</button>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://zfvrszqwuziwmunayfrv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmdnJzenF3dXppd211bmF5ZnJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NTMzNTYsImV4cCI6MjA4MzUyOTM1Nn0.0EGxBLGH8nqXCUPyMV9cJQJLM6oWCBJXpDcIUCDVU6I";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentAttemptId = null;

    async function init() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) { window.location.href = "/index.html"; return; }

      // Get Simulation ID (Grab the first one)
      const { data: sims } = await supabaseClient.from('simulations').select('id').limit(1);
      // Fallback if no simulation exists yet
      let simulationId;
      if (!sims || sims.length === 0) {
         // Create a dummy simulation on the fly if missing so it doesn't crash
         const { data: newSim } = await supabaseClient.from('simulations').insert([{ title: "NDA Review", description: "Standard NDA", time_limit: 75, nda_url: "placeholder" }]).select().single();
         simulationId = newSim.id;
      } else {
         simulationId = sims[0].id;
      }

      // Create Attempt
      const { data: attempt, error } = await supabaseClient
        .from('attempts')
        .insert([{ user_id: session.user.id, simulation_id: simulationId, status: 'started' }])
        .select().single();
      
      if (attempt) currentAttemptId = attempt.id;
    }

    async function submitSimulation() {
      if (!currentAttemptId) return alert("Loading... please wait.");
      
      await supabaseClient.from('responses').insert([{
          attempt_id: currentAttemptId,
          risks: document.getElementById("risks").value,
          clause_edits: document.getElementById("edits").value,
          client_email: document.getElementById("email").value,
          not_change: "N/A"
      }]);

      await supabaseClient.from('attempts').update({ status: 'submitted', submitted_at: new Date() }).eq('id', currentAttemptId);
      
      alert("‚úÖ Submission Received!");
      window.location.href = "/dashboard.html";
    }

    init();
  </script>
</body>
</html>
